extends ../layout

block content
  .max-w-3xl.mx-auto
    h1.text-4xl.font-extrabold.text-blue-900.text-center.mb-8 إدخال تسليم جديد
    
    .bg-white.rounded-xl.shadow-lg.p-8
      form#newEntryForm(method="POST" action="/deliveries" autocomplete="off")
        //- Error Message
        if messages && messages.error
          .bg-red-100.border.border-red-400.text-red-700.px-4.py-3.rounded.mb-4(role="alert")
            p.font-bold خطأ
            p= messages.error
        
        //- Client Selection
        .mb-6
          label.block.text-lg.font-bold.text-blue-900.mb-2(for="client")
            span.text-red-600.font-extrabold.mr-1 *
            | العميل
          select#client.w-full.px-4.py-3.rounded-lg.border.border-gray-300.bg-gray-50.text-blue-900.text-lg.transition-colors(
            name="client_id"
            required
            class="focus:border-blue-500 focus:outline-none"
          )
            option(value="") اختر العميل
            each client in clients
              option(value=client.id)= client.name
        
        //- Material Type
        .mb-6
          label.block.text-lg.font-bold.text-blue-900.mb-2(for="material")
            span.text-red-600.font-extrabold.mr-1 *
            | نوع المادة
          select#material.w-full.px-4.py-3.rounded-lg.border.border-gray-300.bg-gray-50.text-blue-900.text-lg.transition-colors(
            name="material"
            required
            class="focus:border-blue-500 focus:outline-none"
          )
            option(value="") اختر النوع
            option(value="رمل") رمل
            option(value="سن 1") سن 1
            option(value="سن 2") سن 2
            option(value="سن 3") سن 3
            
        
        //- Crusher Selection
        .mb-6
          label.block.text-lg.font-bold.text-blue-900.mb-2(for="crusher")
            span.text-red-600.font-extrabold.mr-1 *
            | الكسارة
          select#crusher.w-full.px-4.py-3.rounded-lg.border.border-gray-300.bg-gray-50.text-blue-900.text-lg.transition-colors(
            name="crusher_id"
            required
            class="focus:border-blue-500 focus:outline-none"
          )
            option(value="") اختر الكسارة
            each crusher in crushers
              option(value=crusher.id)= crusher.name
        
        //- Voucher Number
        .mb-6
          label.block.text-lg.font-bold.text-blue-900.mb-2(for="voucher")
            span.text-red-600.font-extrabold.mr-1 *
            | رقم البون
          input#voucher.w-full.px-4.py-3.rounded-lg.border.border-gray-300.bg-gray-50.text-blue-900.text-lg.transition-colors(
            type="text"
            name="voucher"
            required
            maxlength="32"
            class="focus:border-blue-500 focus:outline-none"
          )
        
        //- Contractor Selection
        .mb-6
          label.block.text-lg.font-bold.text-blue-900.mb-2(for="contractor")
            span.text-red-600.font-extrabold.mr-1 *
            | مقاول النقل
          select#contractor.w-full.px-4.py-3.rounded-lg.border.border-gray-300.bg-gray-50.text-blue-900.text-lg.transition-colors(
            name="contractor_id"
            required
            class="focus:border-blue-500 focus:outline-none"
          )
            option(value="") اختر المقاول
            each contractor in contractors
              option(value=contractor.id)= contractor.name
        
        //- Driver & Car Details (Row)
        .grid.gap-4.mb-6(class="grid-cols-1 sm:grid-cols-3")
          div
            label.block.text-lg.font-bold.text-blue-900.mb-2(for="driver")
              span.text-red-600.font-extrabold.mr-1 *
              | اسم السائق
            input#driver.w-full.px-4.py-3.rounded-lg.border.border-gray-300.bg-gray-50.text-blue-900.text-lg.transition-colors(
              type="text"
              name="driver_name"
              required
              maxlength="48"
              class="focus:border-blue-500 focus:outline-none"
            )
          
          div
            label.block.text-lg.font-bold.text-blue-900.mb-2(for="carHead")
              span.text-red-600.font-extrabold.mr-1 *
              | رقم الرأس
            input#carHead.w-full.px-4.py-3.rounded-lg.border.border-gray-300.bg-gray-50.text-blue-900.text-lg.transition-colors(
              type="text"
              name="car_head"
              required
              maxlength="28"
              class="focus:border-blue-500 focus:outline-none"
            )
          
          div
            label.block.text-lg.font-bold.text-blue-900.mb-2(for="carTail")
              span.text-red-600.font-extrabold.mr-1 *
              | رقم المقطورة
            input#carTail.w-full.px-4.py-3.rounded-lg.border.border-gray-300.bg-gray-50.text-blue-900.text-lg.transition-colors(
              type="text"
              name="car_tail"
              required
              maxlength="28"
              class="focus:border-blue-500 focus:outline-none"
            )
        
        //- Car Volume
        .mb-6
          label.block.text-lg.font-bold.text-blue-900.mb-2(for="carVolume")
            span.text-red-600.font-extrabold.mr-1 *
            | تكعيب السيارة (م³)
          input#carVolume.w-full.px-4.py-3.rounded-lg.border.border-gray-300.bg-gray-50.text-blue-900.text-lg.transition-colors(
            type="number"
            name="car_volume"
            min="0.01"
            step="0.01"
            required
            class="focus:border-blue-500 focus:outline-none"
          )
        
        //- Discount Options
        .mb-6
          .flex.items-center.gap-8.mb-4
            label.flex.items-center.text-lg.font-medium.text-blue-900.cursor-pointer
              input#discountYes.ml-2(
                type="radio"
                name="has_discount"
                value="yes"
                class="w-5 h-5"
              )
              span خصم
            
            label.flex.items-center.text-lg.font-medium.text-blue-900.cursor-pointer
              input#discountNo.ml-2(
                type="radio"
                name="has_discount"
                value="no"
                checked
                class="w-5 h-5"
              )
              span بدون خصم
          
          //- Discount Amount Field (Hidden by default)
          #deductAmountField.hidden.bg-gradient-to-br.from-blue-50.to-blue-100.border-2.border-dashed.border-blue-400.rounded-xl.p-6.shadow-md
            label.block.text-lg.font-extrabold.text-blue-900.mb-3(for="deductAmount")
              span.text-red-600.font-extrabold.mr-1 *
              | قيمة الخصم (م³)
              span.bg-yellow-100.text-yellow-800.px-3.py-1.rounded-full.text-sm.mr-2 خاص
            input#deductAmount.w-2-3.px-4.py-3.rounded-lg.border-2.border-yellow-400.bg-yellow-50.text-yellow-900.font-bold.text-lg.shadow-sm(
              type="number"
              name="discount_volume"
              min="0"
              step="0.01"
              class="focus:border-yellow-600 focus:outline-none"
            )
        
        //- Quantity & Price (Row)
        .grid.gap-4.mb-6(class="grid-cols-1 sm:grid-cols-2")
          div
            label.block.text-lg.font-bold.text-blue-900.mb-2(for="quantity")
              span.text-red-600.font-extrabold.mr-1 *
              | كمية الحمولة (م³)
            input#quantity.w-full.px-4.py-3.rounded-lg.border.border-gray-300.bg-gray-50.text-blue-900.text-lg.transition-colors(
              type="number"
              name="quantity"
              min="0.01"
              step="0.01"
              required
              class="focus:border-blue-500 focus:outline-none"
            )
          
          div
            label.block.text-lg.font-bold.text-blue-900.mb-2(for="price")
              span.text-red-600.font-extrabold.mr-1 *
              | السعر لكل م³
            input#price.w-full.px-4.py-3.rounded-lg.border.border-gray-300.bg-gray-50.text-blue-900.text-lg.transition-colors(
              type="number"
              name="price_per_meter"
              min="0"
              step="0.01"
              required
              class="focus:border-blue-500 focus:outline-none"
            )
        
        
        
        //- Submit Button
        button.w-full.bg-blue-900.text-white.py-4.rounded-lg.text-xl.font-bold.shadow-lg.transition-colors(
          type="submit"
          class="hover:bg-blue-800"
        ) حفظ البيانات

block scripts
  script(src="https://cdn.jsdelivr.net/npm/sweetalert2@11")
  script.
    // Discount toggle
    const discountYes = document.getElementById('discountYes');
    const discountNo = document.getElementById('discountNo');
    const deductAmountField = document.getElementById('deductAmountField');
    const deductAmount = document.getElementById('deductAmount');
    
    discountYes.addEventListener('change', () => {
      if (discountYes.checked) {
        deductAmountField.classList.remove('hidden');
        deductAmount.required = true;
      }
      calcTotal();
    });
    
    discountNo.addEventListener('change', () => {
      if (discountNo.checked) {
        deductAmountField.classList.add('hidden');
        deductAmount.required = false;
        deductAmount.value = '';
      }
      calcTotal();
    });
    
    // Auto-calculate total
    function calcTotal() {
      const q = parseFloat(document.getElementById('quantity').value);
      const p = parseFloat(document.getElementById('price').value);
      const deduct = discountYes.checked ? parseFloat(deductAmount.value) || 0 : 0;
      
      let total = 0;
      if (!isNaN(q) && !isNaN(p)) {
        const net = Math.max(q - Math.max(deduct, 0), 0);
        total = net * p;
      }
      
      document.getElementById('total').value = total > 0 
        ? total.toLocaleString('ar-EG', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
        : '';
    }
    
    document.getElementById('quantity').addEventListener('input', calcTotal);
    document.getElementById('price').addEventListener('input', calcTotal);
    deductAmount.addEventListener('input', calcTotal);
    
    // Hide number input spinners
    const style = document.createElement('style');
    style.textContent = `
      input[type=number]::-webkit-inner-spin-button,
      input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type=number] {
        -moz-appearance: textfield;
      }
    `;
    document.head.appendChild(style);
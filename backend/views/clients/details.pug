extends ../layout

block content
  .max-w-7xl.mx-auto
    //- Page Header
    h1.text-3xl.font-extrabold.text-blue-900.mb-6= client.name
    
    //- Financial Summary Card
    .bg-white.rounded-xl.shadow-md.p-6.mb-6
      h2.text-xl.font-bold.text-blue-800.mb-4 الملخص المالي
      
      .overflow-x-auto
        table.w-full.text-right
          tbody
            
            tr.border-b
              td.py-3.px-4.font-semibold.text-gray-700 رصيد سابق
              - var ob = Number(totals.openingBalance || 0);
              - var obStr = Math.abs(ob).toLocaleString('ar-EG', { style: 'currency', currency: 'EGP', minimumFractionDigits: 2 });
              - var obSuffix = ob < 0 ? ' له' : ob > 0 ? ' عليه' : '';
              td.py-3.px-4.text-gray-900= obStr + obSuffix
           
            tr.border-b
              td.py-3.px-4.font-semibold.text-gray-700 إجمالي التسليمات
              td.py-3.px-4.text-gray-900= totals.totalDeliveries.toLocaleString('ar-EG', { style: 'currency', currency: 'EGP', minimumFractionDigits: 2 })
            
            tr.border-b
              td.py-3.px-4.font-semibold.text-gray-700 إجمالي المدفوعات
              td.py-3.px-4.text-gray-900= totals.totalPayments.toLocaleString('ar-EG', { style: 'currency', currency: 'EGP', minimumFractionDigits: 2 })
            
            tr.border-b
              td.py-3.px-4.font-semibold.text-gray-700 إجمالي التسويات
              td.py-3.px-4.text-gray-900= totals.totalAdjustments.toLocaleString('ar-EG', { style: 'currency', currency: 'EGP', minimumFractionDigits: 2 })
            
            tr.bg-blue-50
              td.py-3.px-4.font-bold.text-blue-900.text-lg الرصيد النهائي
              - var bal = Number(totals.balance || 0);
              - var balStr = Math.abs(bal).toLocaleString('ar-EG', { style: 'currency', currency: 'EGP', minimumFractionDigits: 2 });
              - var balSuffix = bal < 0 ? ' له' : bal > 0 ? ' عليه' : '';
              td.py-3.px-4.font-bold.text-lg(
                class= bal < 0 ? 'text-green-600' : bal > 0 ? 'text-red-600' : 'text-gray-600'
              )= balStr + balSuffix

    //- Material Totals Cards
    if materialTotals && materialTotals.length > 0
      .mb-6
        h2.text-xl.font-bold.text-blue-800.mb-4 إجماليات المواد
        .grid.grid-cols-1.md_grid-cols-2.lg_grid-cols-3.gap-4
          each material in materialTotals
            .bg-white.rounded-xl.shadow-md.p-4.border.border-gray-200
              .text-lg.font-bold.text-blue-900.mb-2= material.material
              .text-sm.text-gray-600.mb-1 الكمية الإجمالية
              .text-xl.font-semibold.text-green-600.mb-2= material.totalQty.toLocaleString('ar-EG', { minimumFractionDigits: 0, maximumFractionDigits: 2 }) + ' طن'
              .text-sm.text-gray-600.mb-1 القيمة الإجمالية
              .text-lg.font-semibold.text-blue-600= material.totalValue.toLocaleString('ar-EG', { style: 'currency', currency: 'EGP', minimumFractionDigits: 2 })
    
    //- Deliveries Section
    .bg-white.rounded-xl.shadow-md.p-6.mb-6
      .flex.justify-between.items-center.mb-4
        h2.text-xl.font-bold.text-blue-800 التسليمات
        span.text-sm.text-gray-600= `${deliveries.length} تسليمة`
      
      if deliveries && deliveries.length > 0
        .overflow-x-auto
          table.w-full.text-center.border-collapse
            thead
              tr.bg-blue-100
                th.border.border-blue-200.px-3.py-2.font-semibold.text-blue-900 التاريخ
                th.border.border-blue-200.px-3.py-2.font-semibold.text-blue-900 نوع الحمولة
                th.border.border-blue-200.px-3.py-2.font-semibold.text-blue-900 رقم البون
                th.border.border-blue-200.px-3.py-2.font-semibold.text-blue-900 الكمية
                th.border.border-blue-200.px-3.py-2.font-semibold.text-blue-900 سعر المتر
                th.border.border-blue-200.px-3.py-2.font-semibold.text-blue-900 الإجمالي
                th.border.border-blue-200.px-3.py-2.font-semibold.text-blue-900 الكسارة
                th.border.border-blue-200.px-3.py-2.font-semibold.text-blue-900 مقاول النقل
            
            tbody
              each delivery in deliveries
                tr.hover_bg-gray-50
                  td.border.border-gray-200.px-3.py-2= new Date(delivery.created_at).toLocaleDateString('ar-EG')
                  td.border.border-gray-200.px-3.py-2= delivery.material || '-'
                  td.border.border-gray-200.px-3.py-2= delivery.voucher || '-'
                  td.border.border-gray-200.px-3.py-2= Number(delivery.quantity || 0).toLocaleString('ar-EG', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
                  td.border.border-gray-200.px-3.py-2= delivery.price_per_meter.toLocaleString('ar-EG', { style: 'currency', currency: 'EGP', minimumFractionDigits: 2 })
                  td.border.border-gray-200.px-3.py-2.font-bold= delivery.total_value.toLocaleString('ar-EG', { style: 'currency', currency: 'EGP', minimumFractionDigits: 2 })
                  td.border.border-gray-200.px-3.py-2= delivery.crusher_name || '-'
                  td.border.border-gray-200.px-3.py-2= delivery.contractor_name || '-'
      else
        p.text-center.text-gray-500.py-4 لا توجد تسليمات
    
    //- Payments Section
    .bg-white.rounded-xl.shadow-md.p-6.mb-6
      .flex.justify-between.items-center.mb-4
        h2.text-xl.font-bold.text-blue-800 المدفوعات
        button#addPaymentBtn.bg-green-600.text-white.px-4.py-2.rounded-lg.text-sm.hover_bg-green-700.transition-colors + إضافة دفعة
      
      if payments && payments.length > 0
        .overflow-x-auto
          table.w-full.text-center.border-collapse
            thead
              tr.bg-blue-100
                th.border.border-blue-200.px-3.py-2.font-semibold.text-blue-900 التاريخ
                th.border.border-blue-200.px-3.py-2.font-semibold.text-blue-900 المبلغ
                th.border.border-blue-200.px-3.py-2.font-semibold.text-blue-900 ملاحظات
            
            tbody
              each payment in payments
                tr.hover_bg-gray-50
                  td.border.border-gray-200.px-3.py-2= new Date(payment.paid_at).toLocaleDateString('ar-EG')
                  td.border.border-gray-200.px-3.py-2.font-bold= payment.amount.toLocaleString('ar-EG', { style: 'currency', currency: 'EGP', minimumFractionDigits: 2 })
                  td.border.border-gray-200.px-3.py-2= payment.note || '-'
      else
        p.text-center.text-gray-500.py-4 لا توجد مدفوعات
    
    //- Adjustments Section
    .bg-white.rounded-xl.shadow-md.p-6.mb-6
      .flex.justify-between.items-center.mb-4
        h2.text-xl.font-bold.text-blue-800 تسويات/مستحقات إضافية
        button#addAdjustmentBtn.bg-orange-600.text-white.px-4.py-2.rounded-lg.text-sm.hover_bg-orange-700.transition-colors + إضافة تسوية
      
      if adjustments && adjustments.length > 0
        .overflow-x-auto
          table.w-full.text-center.border-collapse
            thead
              tr.bg-blue-100
                th.border.border-blue-200.px-3.py-2.font-semibold.text-blue-900 التاريخ
                th.border.border-blue-200.px-3.py-2.font-semibold.text-blue-900 القيمة
                th.border.border-blue-200.px-3.py-2.font-semibold.text-blue-900 السبب
            
            tbody
              each adjustment in adjustments
                tr.hover_bg-gray-50
                  td.border.border-gray-200.px-3.py-2= new Date(adjustment.created_at).toLocaleDateString('ar-EG')
                  td.border.border-gray-200.px-3.py-2.font-bold(
                    class=adjustment.amount > 0 ? 'text-green-600' : 'text-red-600'
                  )= adjustment.amount.toLocaleString('ar-EG', { style: 'currency', currency: 'EGP', minimumFractionDigits: 2 })
                  td.border.border-gray-200.px-3.py-2= adjustment.reason || '-'
      else
        p.text-center.text-gray-500.py-4 لا توجد تسويات
    if materialTotals && materialTotals.length
      .grid(class="grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6")
        each m in materialTotals
          .bg-white.rounded-xl.shadow-md.p-6.flex.flex-col
            .text-sm.text-gray-600.mb-2 نوع الحمولة
            .text-xl.font-bold.mb-2= m.material
            .text-gray-700.mb-1 كمية: 
              span.font-semibold.ml-2= (m.totalQty || 0).toLocaleString('ar-EG', { minimumFractionDigits: 2 }) + ' م³'
       
block scripts
  script(src="https://cdn.jsdelivr.net/npm/sweetalert2@11")
  script.
    // Add Payment
    document.getElementById('addPaymentBtn').addEventListener('click', async function() {
      const { value: amount } = await Swal.fire({
        title: 'المبلغ المدفوع',
        input: 'number',
        inputPlaceholder: 'أدخل المبلغ',
        showCancelButton: true,
        cancelButtonText: 'إلغاء',
        confirmButtonText: 'التالي',
        inputValidator: (value) => {
          if (!value || parseFloat(value) <= 0) {
            return 'يرجى إدخال مبلغ صحيح';
          }
        }
      });
      
      if (!amount) return;
      
      const { value: note } = await Swal.fire({
        title: 'ملاحظات (اختياري)',
        input: 'text',
        inputPlaceholder: 'ملاحظات',
        showCancelButton: true,
        cancelButtonText: 'إلغاء',
        confirmButtonText: 'إضافة'
      });
      
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = window.location.pathname + '/payments';
      
      const amountInput = document.createElement('input');
      amountInput.type = 'hidden';
      amountInput.name = 'amount';
      amountInput.value = amount;
      form.appendChild(amountInput);
      
      if (note) {
        const noteInput = document.createElement('input');
        noteInput.type = 'hidden';
        noteInput.name = 'note';
        noteInput.value = note;
        form.appendChild(noteInput);
      }
      
      document.body.appendChild(form);
      form.submit();
    });
    
    // Add Adjustment
    document.getElementById('addAdjustmentBtn').addEventListener('click', async function() {
      const { value: amount } = await Swal.fire({
        title: 'قيمة التسوية',
        input: 'number',
        inputPlaceholder: 'موجب للإضافة، سالب للخصم',
        showCancelButton: true,
        cancelButtonText: 'إلغاء',
        confirmButtonText: 'التالي',
        inputValidator: (value) => {
          if (!value || parseFloat(value) === 0) {
            return 'يرجى إدخال قيمة صحيحة';
          }
        }
      });
      
      if (amount === undefined) return;
      
      const { value: reason } = await Swal.fire({
        title: 'السبب',
        input: 'text',
        inputPlaceholder: 'سبب التسوية',
        showCancelButton: true,
        cancelButtonText: 'إلغاء',
        confirmButtonText: 'إضافة'
      });
      
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = window.location.pathname + '/adjustments';
      
      const amountInput = document.createElement('input');
      amountInput.type = 'hidden';
      amountInput.name = 'amount';
      amountInput.value = amount;
      form.appendChild(amountInput);
      
      if (reason) {
        const reasonInput = document.createElement('input');
        reasonInput.type = 'hidden';
        reasonInput.name = 'reason';
        reasonInput.value = reason;
        form.appendChild(reasonInput);
      }
      
      document.body.appendChild(form);
      form.submit();
    });